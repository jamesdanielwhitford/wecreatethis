<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#333">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Sync - Birdle</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="styles.css">
  <style>
    .sync-container {
      max-width: 400px;
      margin: 0 auto;
      padding: 20px;
    }

    .sync-header {
      text-align: center;
      padding: 20px 0;
    }

    .sync-header h1 {
      margin: 0 0 5px 0;
      font-size: 24px;
    }

    .sync-header p {
      margin: 0;
      color: #666;
    }

    .sync-intro {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.5;
      text-align: center;
    }

    .sync-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .sync-buttons button {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: #4caf50;
      color: white;
    }

    .sync-buttons button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .sync-buttons button.secondary {
      background: #2196f3;
    }

    .step-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 10px;
    }

    .step-section h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    .step-indicator {
      display: inline-block;
      background: #4caf50;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 14px;
      margin-right: 8px;
    }

    .step-indicator.blue {
      background: #2196f3;
    }

    .code-area {
      width: 100%;
      height: 80px;
      font-family: monospace;
      font-size: 11px;
      padding: 10px;
      border: 2px solid #ddd;
      border-radius: 8px;
      resize: none;
      box-sizing: border-box;
    }

    .code-area:focus {
      border-color: #4caf50;
      outline: none;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .action-btn {
      flex: 1;
      padding: 12px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .action-btn:hover {
      background: #43a047;
    }

    .action-btn.secondary {
      background: #2196f3;
    }

    .action-btn.secondary:hover {
      background: #1e88e5;
    }

    .action-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #status-section {
      display: none;
      margin: 20px 0;
      padding: 20px;
      background: #f0f7f0;
      border-radius: 10px;
      text-align: center;
    }

    #status-section.error {
      background: #fef0f0;
    }

    #status-text {
      font-weight: bold;
      margin-bottom: 10px;
    }

    #progress-text {
      color: #666;
      font-size: 14px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Sticky Navbar -->
  <nav class="game-navbar">
    <a href="index" class="back-btn">&larr; Home</a>
    <span></span>
  </nav>

  <!-- Sync Header -->
  <div class="sync-header">
    <h1>Sync Devices</h1>
    <p>Transfer sightings and games between devices</p>
  </div>

  <div class="sync-container">
    <!-- Start View -->
    <div id="start-view">
      <p class="sync-intro">
        Connect directly to another device. No account needed!
      </p>
      <div class="sync-buttons">
        <button id="start-sync-btn">Start Sync</button>
        <button id="join-sync-btn" class="secondary">Join Sync</button>
      </div>
    </div>

    <!-- Initiator View (Device A) -->
    <div id="initiator-view" class="hidden">
      <div class="step-section">
        <h3><span class="step-indicator">1</span> Send this code to the other device</h3>
        <textarea id="offer-code" class="code-area" readonly placeholder="Generating..."></textarea>
        <div class="btn-row">
          <button id="copy-offer-btn" class="action-btn">Copy Code</button>
        </div>
      </div>

      <div class="step-section">
        <h3><span class="step-indicator blue">2</span> Paste their response here</h3>
        <textarea id="answer-input" class="code-area" placeholder="Paste the response code here..."></textarea>
        <div class="btn-row">
          <button id="connect-btn" class="action-btn secondary">Connect</button>
        </div>
      </div>
    </div>

    <!-- Joiner View (Device B) -->
    <div id="joiner-view" class="hidden">
      <div class="step-section">
        <h3><span class="step-indicator">1</span> Paste the code from the other device</h3>
        <textarea id="offer-input" class="code-area" placeholder="Paste the sync code here..."></textarea>
        <div class="btn-row">
          <button id="generate-response-btn" class="action-btn">Generate Response</button>
        </div>
      </div>

      <div id="response-section" class="step-section hidden">
        <h3><span class="step-indicator blue">2</span> Send this response back</h3>
        <textarea id="answer-code" class="code-area" readonly></textarea>
        <div class="btn-row">
          <button id="copy-answer-btn" class="action-btn secondary">Copy Response</button>
        </div>
      </div>
    </div>

    <!-- Status Section -->
    <div id="status-section">
      <div id="status-text">Connecting...</div>
      <div id="progress-text"></div>
    </div>
  </div>

  <script src="db.js?v=82"></script>
  <script src="sync/webrtc.js?v=82"></script>
  <script src="sync/signaling.js?v=82"></script>
  <script src="sync/sync.js?v=82"></script>
  <script>
    (function() {
      let peer = null;
      let syncManager = null;

      // Elements
      const startView = document.getElementById('start-view');
      const initiatorView = document.getElementById('initiator-view');
      const joinerView = document.getElementById('joiner-view');
      const statusSection = document.getElementById('status-section');
      const statusText = document.getElementById('status-text');
      const progressText = document.getElementById('progress-text');

      // Initiator elements
      const startSyncBtn = document.getElementById('start-sync-btn');
      const offerCode = document.getElementById('offer-code');
      const copyOfferBtn = document.getElementById('copy-offer-btn');
      const answerInput = document.getElementById('answer-input');
      const connectBtn = document.getElementById('connect-btn');

      // Joiner elements
      const joinSyncBtn = document.getElementById('join-sync-btn');
      const offerInput = document.getElementById('offer-input');
      const generateResponseBtn = document.getElementById('generate-response-btn');
      const responseSection = document.getElementById('response-section');
      const answerCode = document.getElementById('answer-code');
      const copyAnswerBtn = document.getElementById('copy-answer-btn');

      // Initialize DB
      BirdDB.init();

      // Start Sync (Initiator)
      startSyncBtn.addEventListener('click', async () => {
        startView.classList.add('hidden');
        initiatorView.classList.remove('hidden');
        offerCode.value = 'Generating connection code...';

        try {
          peer = new PeerConnection();
          await peer.createConnection(true);

          peer.onDataChannelOpen = () => {
            startSyncProcess();
          };

          const offer = await peer.createOffer();
          const encoded = SyncSignaling.encodeForQR(offer);
          offerCode.value = encoded;
        } catch (e) {
          console.error('Failed to create offer:', e);
          offerCode.value = 'Error: ' + e.message;
        }
      });

      // Copy offer code
      copyOfferBtn.addEventListener('click', () => {
        offerCode.select();
        document.execCommand('copy');
        copyOfferBtn.textContent = 'Copied!';
        setTimeout(() => copyOfferBtn.textContent = 'Copy Code', 2000);
      });

      // Connect with answer
      connectBtn.addEventListener('click', async () => {
        const code = answerInput.value.trim();
        if (!code) return;

        try {
          const answer = SyncSignaling.decodeFromQR(code);
          if (answer.type !== 'answer') {
            throw new Error('Invalid response code');
          }
          await peer.acceptAnswer(answer);
          showStatus('Connecting...');
        } catch (e) {
          console.error('Failed to process answer:', e);
          showStatus('Error: Invalid response code', true);
        }
      });

      // Join Sync (Joiner)
      joinSyncBtn.addEventListener('click', () => {
        startView.classList.add('hidden');
        joinerView.classList.remove('hidden');
      });

      // Generate response
      generateResponseBtn.addEventListener('click', async () => {
        const code = offerInput.value.trim();
        if (!code) return;

        try {
          const offer = SyncSignaling.decodeFromQR(code);
          if (offer.type !== 'offer') {
            throw new Error('Invalid sync code');
          }

          peer = new PeerConnection();
          await peer.createConnection(false);

          peer.onDataChannelOpen = () => {
            startSyncProcess();
          };

          const answer = await peer.acceptOffer(offer);
          const encoded = SyncSignaling.encodeForQR(answer);

          answerCode.value = encoded;
          responseSection.classList.remove('hidden');
        } catch (e) {
          console.error('Failed to process offer:', e);
          showStatus('Error: Invalid sync code', true);
        }
      });

      // Copy answer code
      copyAnswerBtn.addEventListener('click', () => {
        answerCode.select();
        document.execCommand('copy');
        copyAnswerBtn.textContent = 'Copied!';
        setTimeout(() => copyAnswerBtn.textContent = 'Copy Response', 2000);
      });

      function startSyncProcess() {
        initiatorView.classList.add('hidden');
        joinerView.classList.add('hidden');
        showStatus('Connected! Syncing...');

        syncManager = new BirdleSync();

        syncManager.onStatusChange = (status) => {
          statusText.textContent = status;
        };

        syncManager.onProgress = (msg) => {
          progressText.textContent = msg;
        };

        syncManager.onComplete = () => {
          statusText.textContent = 'Sync complete!';
          progressText.textContent = 'Returning home...';
          setTimeout(() => {
            window.location.href = 'index';
          }, 2000);
        };

        syncManager.onError = (error) => {
          showStatus('Error: ' + error.message, true);
        };

        syncManager.startSync(peer);
      }

      function showStatus(message, isError = false) {
        initiatorView.classList.add('hidden');
        joinerView.classList.add('hidden');
        statusSection.style.display = 'block';
        statusSection.classList.toggle('error', isError);
        statusText.textContent = message;
        progressText.textContent = '';
      }

      // Cleanup
      window.addEventListener('beforeunload', () => {
        if (syncManager) syncManager.abort();
        if (peer) peer.close();
      });
    })();
  </script>
</body>
</html>
