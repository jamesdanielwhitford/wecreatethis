<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#333">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Manage Cache - Birdle</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles.css">
  <style>
    .cache-list {
      list-style: none;
      margin-top: 16px;
    }
    .cache-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .cache-info {
      flex: 1;
    }
    .cache-name {
      font-weight: 500;
    }
    .cache-meta {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .cache-delete {
      background: none;
      border: none;
      color: #c00;
      font-size: 20px;
      cursor: pointer;
      padding: 8px;
    }
    .add-cache-section {
      margin-top: 24px;
      padding-top: 16px;
      border-top: 2px solid #eee;
    }
    .add-cache-section h3 {
      margin-bottom: 12px;
      font-size: 16px;
    }
    .add-cache-row {
      display: flex;
      gap: 8px;
    }
    .add-cache-row select {
      flex: 1;
      min-width: 0;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .add-cache-row button {
      flex-shrink: 0;
      padding: 10px 16px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
    }
    .add-cache-row button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .empty-state {
      text-align: center;
      color: #666;
      padding: 40px 20px;
    }
    .progress-text {
      font-size: 13px;
      color: #666;
      margin-top: 8px;
    }
    .total-summary {
      margin-top: 16px;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <a href="index" class="back-btn">&larr; Back</a>
  <h1>Manage Cache</h1>
  <p class="hint" style="color: #666; font-size: 14px; margin-top: 4px;">Cache countries for offline bird searching</p>

  <div id="total-summary" class="total-summary" style="display: none;">
    <strong id="total-countries">0</strong> countries cached (<strong id="total-birds">0</strong> birds)
  </div>

  <ul id="cache-list" class="cache-list"></ul>
  <div id="empty-state" class="empty-state" style="display: none;">
    No countries cached yet.<br>Add a country below to enable offline searching.
  </div>

  <div class="add-cache-section">
    <h3>Add Country</h3>
    <div class="add-cache-row">
      <select id="country-select">
        <option value="">Select country...</option>
      </select>
      <button id="add-cache-btn" disabled>Cache</button>
    </div>
    <p id="progress-text" class="progress-text" style="display: none;"></p>
  </div>

  <script src="db.js?v=85"></script>
  <script src="ebird.js?v=85"></script>
  <script>
    (async function() {
      const cacheList = document.getElementById('cache-list');
      const emptyState = document.getElementById('empty-state');
      const totalSummary = document.getElementById('total-summary');
      const totalCountries = document.getElementById('total-countries');
      const totalBirds = document.getElementById('total-birds');
      const countrySelect = document.getElementById('country-select');
      const addBtn = document.getElementById('add-cache-btn');
      const progressText = document.getElementById('progress-text');

      let countries = [];
      let cachedCountries = [];

      await BirdDB.init();

      // Load countries for dropdown
      async function loadCountries() {
        countries = await EBird.getCountries();
        updateDropdown();
      }

      // Update dropdown to exclude already cached countries
      function updateDropdown() {
        const cachedCodes = cachedCountries.map(c => c.countryCode);
        countrySelect.innerHTML = '<option value="">Select country...</option>';
        countries
          .filter(c => !cachedCodes.includes(c.code))
          .forEach(c => {
            countrySelect.innerHTML += `<option value="${c.code}">${c.name}</option>`;
          });
      }

      // Render the cache list
      async function renderCacheList() {
        cachedCountries = await BirdDB.getCachedCountries();
        cacheList.innerHTML = '';

        if (cachedCountries.length === 0) {
          emptyState.style.display = 'block';
          totalSummary.style.display = 'none';
        } else {
          emptyState.style.display = 'none';
          totalSummary.style.display = 'block';

          let totalBirdCount = 0;
          cachedCountries.forEach(cache => {
            totalBirdCount += cache.birdCount;
            const countryName = countries.find(c => c.code === cache.countryCode)?.name || cache.countryCode;
            const cachedDate = new Date(cache.cachedAt).toLocaleDateString();

            const li = document.createElement('li');
            li.className = 'cache-item';
            li.innerHTML = `
              <div class="cache-info">
                <div class="cache-name">${countryName}</div>
                <div class="cache-meta">${cache.birdCount} birds &bull; cached ${cachedDate}</div>
              </div>
              <button class="cache-delete" data-code="${cache.countryCode}" title="Remove cache">&times;</button>
            `;
            cacheList.appendChild(li);
          });

          totalCountries.textContent = cachedCountries.length;
          totalBirds.textContent = totalBirdCount.toLocaleString();
        }

        updateDropdown();
      }

      // Add cache for a country
      async function addCache(countryCode) {
        addBtn.disabled = true;
        countrySelect.disabled = true;
        progressText.style.display = 'block';
        progressText.textContent = 'Starting...';

        try {
          await BirdDB.cacheCountryBirds(countryCode, (progress) => {
            if (progress.phase === 'fetching') {
              progressText.textContent = `Fetching ${progress.total} species...`;
            } else if (progress.phase === 'caching') {
              progressText.textContent = `Caching ${progress.cached}/${progress.total}...`;
            } else if (progress.phase === 'done') {
              progressText.textContent = `Done! ${progress.cached} birds cached.`;
            }
          });

          await renderCacheList();
          countrySelect.value = '';
          setTimeout(() => {
            progressText.style.display = 'none';
          }, 2000);
        } catch (error) {
          console.error('Cache error:', error);
          progressText.textContent = 'Error caching country. Please try again.';
          progressText.style.color = '#c00';
        }

        addBtn.disabled = true;
        countrySelect.disabled = false;
      }

      // Remove cache for a country
      async function removeCache(countryCode) {
        const countryName = countries.find(c => c.code === countryCode)?.name || countryCode;
        if (!confirm(`Remove cache for ${countryName}?\n\nBirds you've logged sightings for will be preserved.`)) {
          return;
        }

        const result = await BirdDB.removeCountryFromCache(countryCode);
        console.log('Removed cache:', result);
        await renderCacheList();
      }

      // Event listeners
      countrySelect.addEventListener('change', () => {
        addBtn.disabled = !countrySelect.value;
      });

      addBtn.addEventListener('click', () => {
        if (countrySelect.value) {
          addCache(countrySelect.value);
        }
      });

      cacheList.addEventListener('click', (e) => {
        if (e.target.classList.contains('cache-delete')) {
          const code = e.target.dataset.code;
          if (code) removeCache(code);
        }
      });

      // Initial load
      await loadCountries();
      await renderCacheList();
    })();
  </script>
</body>
</html>
