<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#333">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Location & Cache - Birdle</title>
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" href="styles.css">
  <style>
    .section {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 2px solid #eee;
    }
    .section:last-child {
      border-bottom: none;
    }
    .section h2 {
      font-size: 16px;
      margin-bottom: 12px;
    }
    .current-location-display {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .current-location-display .location-name {
      font-weight: 500;
      font-size: 16px;
    }
    .current-location-display .location-status {
      font-size: 13px;
      color: #666;
      margin-top: 4px;
    }
    .current-location-display .location-status.cached {
      color: #4caf50;
    }
    .current-location-display .location-status.not-cached {
      color: #c00;
    }
    .location-form {
      margin-top: 12px;
    }
    .location-form .form-row {
      margin-bottom: 12px;
    }
    .location-form select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .location-form select:disabled {
      background: #f5f5f5;
      color: #999;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    .btn-action {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .btn-action:active {
      transform: scale(0.98);
    }
    .btn-action:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    .btn-action.primary {
      background: #4caf50;
      color: white;
    }
    .btn-action.secondary {
      background: #f5f5f5;
      color: #333;
    }
    .btn-action.full-width {
      flex: none;
      width: 100%;
    }
    .cache-list {
      list-style: none;
      margin-top: 12px;
    }
    .cache-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .cache-item.current {
      background: #e8f5e9;
      border: 2px solid #4caf50;
    }
    .cache-info {
      flex: 1;
    }
    .cache-name {
      font-weight: 500;
    }
    .cache-meta {
      font-size: 12px;
      color: #666;
      margin-top: 2px;
    }
    .cache-actions {
      display: flex;
      gap: 8px;
    }
    .cache-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .cache-btn:hover {
      background: rgba(0,0,0,0.05);
    }
    .cache-btn.delete {
      color: #c00;
    }
    .cache-btn.refresh {
      color: #2196f3;
    }
    .empty-state {
      text-align: center;
      color: #666;
      padding: 24px;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .progress-container {
      margin-top: 12px;
      display: none;
    }
    .progress-container.visible {
      display: block;
    }
    .progress-text {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }
    .total-summary {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 12px;
    }
  </style>
</head>
<body>
  <a href="index" class="back-btn">&larr; Back</a>
  <h1>Location & Cache</h1>

  <!-- Current Location Section -->
  <div class="section">
    <h2>Current Location</h2>
    <div id="current-location-display" class="current-location-display">
      <div class="location-name" id="current-location-name">No location set</div>
      <div class="location-status" id="current-location-status"></div>
    </div>

    <button id="use-gps-btn" class="btn-action secondary full-width">
      üìç Use Current GPS Location
    </button>

    <div class="location-form">
      <div class="form-row">
        <select id="country-select">
          <option value="">Select Country...</option>
        </select>
      </div>
      <div class="form-row">
        <select id="state-select" disabled>
          <option value="">Select State/Province...</option>
        </select>
      </div>
      <div class="btn-row">
        <button id="set-location-btn" class="btn-action secondary" disabled>Set Location</button>
        <button id="download-btn" class="btn-action primary" disabled>Download for Offline</button>
      </div>
    </div>

    <div id="progress-container" class="progress-container">
      <div id="progress-text" class="progress-text">Starting download...</div>
      <div class="progress-bar-container">
        <div id="progress-bar" class="progress-bar"></div>
      </div>
    </div>
  </div>

  <!-- Cached Countries Section -->
  <div class="section">
    <h2>Downloaded Countries</h2>
    <div id="total-summary" class="total-summary" style="display: none;">
      <strong id="total-countries">0</strong> countries (<strong id="total-birds">0</strong> birds)
    </div>
    <ul id="cache-list" class="cache-list"></ul>
    <div id="empty-state" class="empty-state" style="display: none;">
      No countries downloaded yet.<br>Download a country to enable offline searching.
    </div>
  </div>

  <!-- Sync Section -->
  <div class="section">
    <a href="sync" class="btn-action secondary full-width" style="display: block; text-align: center; text-decoration: none;">
      üîÑ Sync Between Devices
    </a>
  </div>

  <script src="db.js?v=99"></script>
  <script src="location.js?v=99"></script>
  <script src="ebird.js?v=99"></script>
  <script>
    (async function() {
      // Elements
      const currentLocationName = document.getElementById('current-location-name');
      const currentLocationStatus = document.getElementById('current-location-status');
      const useGpsBtn = document.getElementById('use-gps-btn');
      const countrySelect = document.getElementById('country-select');
      const stateSelect = document.getElementById('state-select');
      const setLocationBtn = document.getElementById('set-location-btn');
      const downloadBtn = document.getElementById('download-btn');
      const progressContainer = document.getElementById('progress-container');
      const progressText = document.getElementById('progress-text');
      const progressBar = document.getElementById('progress-bar');
      const cacheList = document.getElementById('cache-list');
      const emptyState = document.getElementById('empty-state');
      const totalSummary = document.getElementById('total-summary');
      const totalCountries = document.getElementById('total-countries');
      const totalBirds = document.getElementById('total-birds');

      let countries = [];
      let cachedCountries = [];

      await BirdDB.init();

      // Get globe emoji based on continent
      function getGlobeEmoji(countryCode) {
        const continent = BirdDB.getContinent(countryCode);
        if (continent === 'Africa' || continent === 'Europe') return 'üåç';
        if (continent === 'Asia' || continent === 'Oceania') return 'üåè';
        if (continent === 'North America' || continent === 'South America') return 'üåé';
        return 'üåç';
      }

      // Update current location display
      async function updateCurrentLocationDisplay() {
        const cached = LocationService.getCached();

        if (cached) {
          const displayName = LocationService.getRegionDisplayName(cached);
          const globe = getGlobeEmoji(cached.countryCode);
          currentLocationName.textContent = `${globe} ${displayName}`;

          // Check if country is cached
          const hasCache = await BirdDB.hasCountryCache(cached.countryCode);
          if (hasCache) {
            const meta = await BirdDB.getCountryCacheMeta(cached.countryCode);
            currentLocationStatus.textContent = `‚úì ${meta.speciesCodes.length} birds downloaded`;
            currentLocationStatus.className = 'location-status cached';
          } else {
            currentLocationStatus.textContent = '‚ö† Not downloaded for offline use';
            currentLocationStatus.className = 'location-status not-cached';
          }

          // Pre-select in dropdowns
          if (cached.countryCode && countrySelect.value !== cached.countryCode) {
            countrySelect.value = cached.countryCode;
            await loadStates(cached.countryCode);
            if (cached.stateCode) {
              stateSelect.value = cached.stateCode;
            }
          }
        } else {
          currentLocationName.textContent = 'No location set';
          currentLocationStatus.textContent = 'Set a location to get started';
          currentLocationStatus.className = 'location-status';
        }

        updateButtonStates();
      }

      // Load countries dropdown
      async function loadCountries() {
        countries = await EBird.getCountries();
        countrySelect.innerHTML = '<option value="">Select Country...</option>';
        countries.forEach(c => {
          countrySelect.innerHTML += `<option value="${c.code}">${c.name}</option>`;
        });
      }

      // Load states for selected country
      async function loadStates(countryCode) {
        stateSelect.innerHTML = '<option value="">Loading...</option>';
        stateSelect.disabled = true;

        if (countryCode) {
          const states = await EBird.getStates(countryCode);
          stateSelect.innerHTML = '<option value="">Select State/Province...</option>';
          states.forEach(s => {
            stateSelect.innerHTML += `<option value="${s.code}">${s.name}</option>`;
          });
          stateSelect.disabled = false;
        } else {
          stateSelect.innerHTML = '<option value="">Select State/Province...</option>';
        }
      }

      // Update button states
      async function updateButtonStates() {
        const countryCode = countrySelect.value;
        setLocationBtn.disabled = !countryCode;
        downloadBtn.disabled = !countryCode;

        if (countryCode) {
          const hasCache = await BirdDB.hasCountryCache(countryCode);
          downloadBtn.textContent = hasCache ? 'Re-download' : 'Download for Offline';
        } else {
          downloadBtn.textContent = 'Download for Offline';
        }
      }

      // Set location from dropdowns
      function setLocationFromDropdowns() {
        const countryCode = countrySelect.value;
        const stateCode = stateSelect.value || null;

        if (!countryCode) return;

        const countryName = countrySelect.options[countrySelect.selectedIndex].text;
        const stateName = stateCode ? stateSelect.options[stateSelect.selectedIndex].text : null;

        const location = {
          lat: 0,
          lng: 0,
          countryCode,
          countryName,
          stateCode,
          stateName,
          displayName: stateName ? `${stateName}, ${countryName}` : countryName
        };
        LocationService.saveToCache(location);
        updateCurrentLocationDisplay();
      }

      // Download country for offline use
      async function downloadCountry() {
        const countryCode = countrySelect.value;
        if (!countryCode) return;

        // Set location first
        setLocationFromDropdowns();

        // Show progress
        progressContainer.classList.add('visible');
        progressText.textContent = 'Starting download...';
        progressBar.style.width = '0%';
        downloadBtn.disabled = true;
        setLocationBtn.disabled = true;

        try {
          await BirdDB.cacheCountryBirds(countryCode, (progress) => {
            if (progress.phase === 'fetching') {
              progressText.textContent = `Found ${progress.total} species...`;
              progressBar.style.width = '10%';
            } else if (progress.phase === 'caching') {
              const percent = Math.round((progress.cached / progress.total) * 100);
              progressText.textContent = `Downloading ${progress.cached}/${progress.total}...`;
              progressBar.style.width = `${percent}%`;
            } else if (progress.phase === 'done') {
              progressText.textContent = `Done! ${progress.cached} birds ready for offline use.`;
              progressBar.style.width = '100%';
            }
          });

          await updateCurrentLocationDisplay();
          await renderCacheList();

          setTimeout(() => {
            progressContainer.classList.remove('visible');
            updateButtonStates();
          }, 2000);
        } catch (error) {
          console.error('Download error:', error);
          progressText.textContent = 'Error downloading. Please try again.';
          progressText.style.color = '#c00';
          setTimeout(() => {
            progressContainer.classList.remove('visible');
            progressText.style.color = '';
            updateButtonStates();
          }, 3000);
        }
      }

      // Use GPS location
      async function useGpsLocation() {
        const originalText = useGpsBtn.textContent;
        useGpsBtn.textContent = '‚è≥ Getting location...';
        useGpsBtn.disabled = true;

        try {
          await LocationService.getLocation(true);
          await updateCurrentLocationDisplay();
        } catch (error) {
          alert(error.message);
        }

        useGpsBtn.textContent = originalText;
        useGpsBtn.disabled = false;
      }

      // Render the cache list
      async function renderCacheList() {
        cachedCountries = await BirdDB.getCachedCountries();
        const currentLocation = LocationService.getCached();
        cacheList.innerHTML = '';

        if (cachedCountries.length === 0) {
          emptyState.style.display = 'block';
          totalSummary.style.display = 'none';
        } else {
          emptyState.style.display = 'none';
          totalSummary.style.display = 'block';

          let totalBirdCount = 0;
          cachedCountries.forEach(cache => {
            totalBirdCount += cache.birdCount;
            const countryName = countries.find(c => c.code === cache.countryCode)?.name || cache.countryCode;
            const cachedDate = new Date(cache.cachedAt).toLocaleDateString();
            const isCurrent = currentLocation && currentLocation.countryCode === cache.countryCode;
            const globe = getGlobeEmoji(cache.countryCode);

            const li = document.createElement('li');
            li.className = 'cache-item' + (isCurrent ? ' current' : '');
            li.innerHTML = `
              <div class="cache-info">
                <div class="cache-name">${globe} ${countryName}${isCurrent ? ' (current)' : ''}</div>
                <div class="cache-meta">${cache.birdCount} birds ‚Ä¢ cached ${cachedDate}</div>
              </div>
              <div class="cache-actions">
                <button class="cache-btn refresh" data-code="${cache.countryCode}" title="Re-download">üîÑ</button>
                <button class="cache-btn delete" data-code="${cache.countryCode}" title="Delete">√ó</button>
              </div>
            `;
            cacheList.appendChild(li);
          });

          totalCountries.textContent = cachedCountries.length;
          totalBirds.textContent = totalBirdCount.toLocaleString();
        }
      }

      // Remove cache for a country
      async function removeCache(countryCode) {
        const countryName = countries.find(c => c.code === countryCode)?.name || countryCode;
        if (!confirm(`Remove downloaded data for ${countryName}?\n\nBirds you've logged sightings for will be preserved.`)) {
          return;
        }

        await BirdDB.removeCountryFromCache(countryCode);
        await updateCurrentLocationDisplay();
        await renderCacheList();
      }

      // Re-download cache for a country
      async function redownloadCache(countryCode) {
        countrySelect.value = countryCode;
        await loadStates(countryCode);
        await downloadCountry();
      }

      // Event listeners
      useGpsBtn.addEventListener('click', useGpsLocation);

      countrySelect.addEventListener('change', async (e) => {
        await loadStates(e.target.value);
        await updateButtonStates();
      });

      stateSelect.addEventListener('change', updateButtonStates);

      setLocationBtn.addEventListener('click', () => {
        setLocationFromDropdowns();
      });

      downloadBtn.addEventListener('click', downloadCountry);

      cacheList.addEventListener('click', (e) => {
        const btn = e.target.closest('.cache-btn');
        if (!btn) return;

        const code = btn.dataset.code;
        if (btn.classList.contains('delete')) {
          removeCache(code);
        } else if (btn.classList.contains('refresh')) {
          redownloadCache(code);
        }
      });

      // Initial load
      await loadCountries();
      await updateCurrentLocationDisplay();
      await renderCacheList();
    })();
  </script>
</body>
</html>
