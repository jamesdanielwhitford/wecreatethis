<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#333">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Birdle</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="game-navbar">
    <span style="font-weight: bold; font-size: 18px;">Birdle</span>
    <button id="menu-btn" class="menu-btn">&#8942;</button>
    <div id="menu-dropdown" class="menu-dropdown" style="display:none;">
      <button id="menu-manage-cache">Manage Cache</button>
    </div>
  </nav>

  <div class="button-container">
    <a href="#" id="location-btn" class="btn location-unset">
      <span class="btn-icon" id="location-icon">ğŸ“</span>
      <span class="btn-text" id="location-text">Grant location access</span>
    </a>

    <a href="search" class="btn">
      <span class="btn-icon">ğŸ”</span>
      <span class="btn-text">Search</span>
    </a>

    <a href="life" class="btn">
      <span class="btn-icon">ğŸ“‹</span>
      <span class="btn-text">Life List</span>
    </a>

    <a href="bingo-games" class="btn">
      <span class="btn-icon">ğŸ²</span>
      <span class="btn-text">Bird Bingo</span>
    </a>
  </div>

  <script src="db.js?v=99"></script>
  <script src="location.js?v=99"></script>
  <script src="ebird.js?v=99"></script>
  <script src="app.js?v=99"></script>
  <script>
    // Menu button handling
    (function() {
      const menuBtn = document.getElementById('menu-btn');
      const menuDropdown = document.getElementById('menu-dropdown');
      const manageCacheBtn = document.getElementById('menu-manage-cache');

      menuBtn.addEventListener('click', () => {
        const isVisible = menuDropdown.style.display === 'block';
        menuDropdown.style.display = isVisible ? 'none' : 'block';
      });

      manageCacheBtn.addEventListener('click', () => {
        window.location.href = 'cache';
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
          menuDropdown.style.display = 'none';
        }
      });
    })();

    // Location status handling
    (function() {
      const locationBtn = document.getElementById('location-btn');
      const locationIcon = document.getElementById('location-icon');
      const locationText = document.getElementById('location-text');

      // Get globe emoji based on continent
      function getGlobeEmoji(countryCode) {
        const continent = BirdDB.getContinent(countryCode);

        if (continent === 'Africa' || continent === 'Europe') {
          return 'ğŸŒ';
        } else if (continent === 'Asia' || continent === 'Oceania') {
          return 'ğŸŒ';
        } else if (continent === 'North America' || continent === 'South America') {
          return 'ğŸŒ';
        } else {
          return 'ğŸŒ';
        }
      }

      // Update location button text and icon
      function updateLocationButton() {
        const cached = LocationService.getCached();

        if (cached) {
          const displayName = LocationService.getRegionDisplayName(cached);
          const globe = getGlobeEmoji(cached.countryCode);
          locationIcon.textContent = globe;
          locationText.textContent = displayName;
          locationBtn.classList.add('location-set');
          locationBtn.classList.remove('location-unset');
        } else {
          locationIcon.textContent = 'ğŸ“';
          locationText.textContent = 'Grant location access';
          locationBtn.classList.add('location-unset');
          locationBtn.classList.remove('location-set');
        }
      }

      // Handle location button click
      locationBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const cached = LocationService.getCached();

        if (cached) {
          // Already have location - go to cache page
          window.location.href = 'cache';
        } else {
          // No location - request GPS immediately
          locationIcon.textContent = 'â³';
          locationText.textContent = 'Getting location...';
          locationBtn.style.pointerEvents = 'none';

          try {
            await LocationService.getLocation(true);
            updateLocationButton();
            // Navigate to cache page after getting location
            window.location.href = 'cache';
          } catch (error) {
            alert(error.message);
            updateLocationButton();
            locationBtn.style.pointerEvents = 'auto';
          }
        }
      });

      // Initialize on load
      updateLocationButton();
    })();

    // Force service worker update
    if ('serviceWorker' in navigator) {
      // Get all registrations and update them
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(registration => {
          console.log('Updating service worker...');
          registration.update();
        });
      });

      // Register service worker with update checking
      navigator.serviceWorker.register('/birdle/sw.js', {
        scope: '/birdle/',
        updateViaCache: 'none'  // Don't cache the service worker file itself
      }).then(registration => {
        console.log('Service worker registered, checking for updates...');
        registration.update();

        // Check for updates every 5 seconds during development
        setInterval(() => {
          registration.update();
        }, 5000);
      });
    }
  </script>
</body>
</html>
