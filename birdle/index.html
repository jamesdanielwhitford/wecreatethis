<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#333">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Birdle</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="game-navbar">
    <span style="font-weight: bold; font-size: 18px;">Birdle</span>
  </nav>

  <p style="margin-top: 20px;">Bird Bingo Adventure</p>

  <div id="location-status">
    <a href="#" id="grant-location" style="color: #c00;">Grant location access</a>
    <a href="#" id="current-location" style="color: #4caf50; display: none;"></a>
    <br>
    <a href="#" id="update-location" style="color: #2196f3; display: none;"></a>
    <div id="cache-status" style="display: none; font-size: 12px; color: #666; margin-top: 4px;"></div>
  </div>

  <!-- Location Modal -->
  <div id="location-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Set Location</h3>
      <div class="form-group">
        <label>Country</label>
        <select id="modal-country" class="form-select">
          <option value="">Select Country...</option>
        </select>
      </div>
      <div class="form-group">
        <label>State/Province</label>
        <select id="modal-state" class="form-select" disabled>
          <option value="">Select State/Province...</option>
        </select>
      </div>
      <div class="modal-actions">
        <button id="modal-save-btn" class="modal-btn seen" disabled>Save</button>
        <button id="modal-cancel-btn" class="modal-btn cancel">Cancel</button>
      </div>
    </div>
  </div>

  <div class="button-container">
    <a href="search" class="btn">
      <span class="btn-icon">üîç</span>
      <span class="btn-text">Search</span>
    </a>

    <a href="life" class="btn">
      <span class="btn-icon">üìã</span>
      <span class="btn-text">Life List</span>
    </a>

    <a href="bingo-games" class="btn">
      <span class="btn-icon">üé≤</span>
      <span class="btn-text">Bird Bingo</span>
    </a>

    <a href="cache" class="btn">
      <span class="btn-icon">üíæ</span>
      <span class="btn-text">Manage Cache</span>
    </a>
  </div>

  <script src="db.js?v=89"></script>
  <script src="location.js?v=89"></script>
  <script src="ebird.js?v=89"></script>
  <script src="app.js?v=89"></script>
  <script>
    // Location status handling
    (function() {
      const grantLink = document.getElementById('grant-location');
      const currentLocation = document.getElementById('current-location');
      const updateLink = document.getElementById('update-location');
      const cacheStatus = document.getElementById('cache-status');
      const modal = document.getElementById('location-modal');
      const countrySelect = document.getElementById('modal-country');
      const stateSelect = document.getElementById('modal-state');
      const saveBtn = document.getElementById('modal-save-btn');
      const cancelBtn = document.getElementById('modal-cancel-btn');

      let selectedCountry = null;
      let selectedState = null;

      // Cache country birds when location is set
      async function cacheCountryBirds(countryCode) {
        if (!countryCode) return;

        try {
          await BirdDB.init();

          // Check if already cached
          const hasCache = await BirdDB.hasCountryCache(countryCode);
          if (hasCache) {
            const meta = await BirdDB.getCountryCacheMeta(countryCode);
            cacheStatus.textContent = `${meta.speciesCodes.length} birds cached`;
            cacheStatus.style.display = 'block';
            cacheStatus.style.color = '#4caf50';
            return;
          }

          // Show caching status
          cacheStatus.style.display = 'block';
          cacheStatus.style.color = '#666';
          cacheStatus.textContent = 'Caching birds...';

          const result = await BirdDB.cacheCountryBirds(countryCode, (progress) => {
            if (progress.phase === 'fetching') {
              cacheStatus.textContent = `Fetching ${progress.total} species...`;
            } else if (progress.phase === 'caching') {
              cacheStatus.textContent = `Caching ${progress.cached}/${progress.total}...`;
            } else if (progress.phase === 'done') {
              cacheStatus.textContent = `${progress.cached} birds cached`;
              cacheStatus.style.color = '#4caf50';
            }
          });
          console.log('Country birds cached:', result);
        } catch (error) {
          console.error('Error with country cache:', error);
        }
      }

      function showLocationStatus() {
        const cached = LocationService.getCached();
        if (cached) {
          const displayName = LocationService.getRegionDisplayName(cached);
          grantLink.style.display = 'none';
          currentLocation.textContent = displayName;
          currentLocation.style.display = 'inline';
          updateLink.textContent = 'Update with current location';
          updateLink.style.display = 'inline-block';

          // Check/trigger country cache
          cacheCountryBirds(cached.countryCode);
        } else {
          grantLink.style.display = 'inline';
          currentLocation.style.display = 'none';
          updateLink.style.display = 'none';
          cacheStatus.style.display = 'none';
        }
      }

      async function requestLocation() {
        grantLink.textContent = 'Getting location...';
        grantLink.style.color = '#666';
        try {
          await LocationService.getLocation(true);
          showLocationStatus();
        } catch (error) {
          grantLink.textContent = 'Grant location access';
          grantLink.style.color = '#c00';
          alert(error.message);
        }
      }

      async function openModal() {
        modal.style.display = 'flex';

        // Load countries if not already loaded
        if (countrySelect.options.length <= 1) {
          countrySelect.innerHTML = '<option value="">Loading...</option>';
          const countries = await EBird.getCountries();
          countrySelect.innerHTML = '<option value="">Select Country...</option>';
          countries.forEach(c => {
            countrySelect.innerHTML += `<option value="${c.code}">${c.name}</option>`;
          });
        }

        // Pre-select current location if cached
        const cached = LocationService.getCached();
        if (cached && cached.countryCode) {
          countrySelect.value = cached.countryCode;
          await loadStates(cached.countryCode);
          if (cached.stateCode) {
            stateSelect.value = cached.stateCode;
          }
          validateForm();
        }
      }

      async function loadStates(countryCode) {
        stateSelect.innerHTML = '<option value="">Loading...</option>';
        stateSelect.disabled = true;

        if (countryCode) {
          const states = await EBird.getStates(countryCode);
          stateSelect.innerHTML = '<option value="">Select State/Province...</option>';
          states.forEach(s => {
            stateSelect.innerHTML += `<option value="${s.code}">${s.name}</option>`;
          });
          stateSelect.disabled = false;
        } else {
          stateSelect.innerHTML = '<option value="">Select State/Province...</option>';
        }
      }

      function validateForm() {
        saveBtn.disabled = !countrySelect.value;
      }

      function saveManualLocation() {
        const countryCode = countrySelect.value;
        const countryName = countrySelect.options[countrySelect.selectedIndex].text;
        const stateCode = stateSelect.value || null;
        const stateName = stateCode ? stateSelect.options[stateSelect.selectedIndex].text : null;

        const location = {
          lat: 0,
          lng: 0,
          countryCode,
          countryName,
          stateCode,
          stateName,
          displayName: stateName ? `${stateName}, ${countryName}` : countryName
        };

        LocationService.saveToCache(location);
        modal.style.display = 'none';
        showLocationStatus();
      }

      // Event listeners
      grantLink.addEventListener('click', (e) => {
        e.preventDefault();
        requestLocation();
      });

      currentLocation.addEventListener('click', (e) => {
        e.preventDefault();
        openModal();
      });

      updateLink.addEventListener('click', (e) => {
        e.preventDefault();
        const originalText = updateLink.textContent;
        updateLink.textContent = 'Updating...';
        LocationService.getLocation(true).then(() => {
          showLocationStatus();
        }).catch((error) => {
          updateLink.textContent = originalText;
          alert(error.message);
        });
      });

      countrySelect.addEventListener('change', async (e) => {
        await loadStates(e.target.value);
        validateForm();
      });

      stateSelect.addEventListener('change', validateForm);

      saveBtn.addEventListener('click', saveManualLocation);

      cancelBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.style.display = 'none';
        }
      });

      showLocationStatus();
    })();

    // Force service worker update
    if ('serviceWorker' in navigator) {
      // Get all registrations and update them
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(registration => {
          console.log('Updating service worker...');
          registration.update();
        });
      });

      // Register service worker with update checking
      navigator.serviceWorker.register('/birdle/sw.js', {
        scope: '/birdle/',
        updateViaCache: 'none'  // Don't cache the service worker file itself
      }).then(registration => {
        console.log('Service worker registered, checking for updates...');
        registration.update();

        // Check for updates every 5 seconds during development
        setInterval(() => {
          registration.update();
        }, 5000);
      });
    }
  </script>
</body>
</html>
