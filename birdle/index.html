<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#333">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Birdle</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="game-navbar">
    <a href="/" class="home-btn"></a>
    <span style="font-weight: bold; font-size: 18px;">Birdle</span>
  </nav>

  <div class="button-container">
    <a href="#" id="location-btn" class="btn location-unset">
      <span class="btn-icon" id="location-icon">ğŸ“</span>
      <span class="btn-text" id="location-text">Grant location access</span>
    </a>

    <a href="search.html" class="btn requires-location">
      <span class="btn-icon">ğŸ”</span>
      <span class="btn-text">Search</span>
    </a>

    <a href="life.html" class="btn requires-location">
      <span class="btn-icon">ğŸ“‹</span>
      <span class="btn-text">Life List</span>
    </a>

    <a href="bingo-games.html" class="btn requires-location">
      <span class="btn-icon">ğŸ²</span>
      <span class="btn-text">Bird Bingo</span>
    </a>
  </div>

  <!-- Location Access Modal -->
  <div id="location-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Location Required</h3>
      <p style="margin-bottom: 20px; color: #666;">Birdle needs your location to find birds in your area. Please grant location access to continue.</p>
      <div class="modal-actions">
        <button id="modal-grant-btn" class="modal-btn seen">Grant Location Access</button>
        <button id="modal-close-btn" class="modal-btn cancel">Close</button>
      </div>
    </div>
  </div>

  <script src="db.js"></script>
  <script src="location.js"></script>
  <script src="ebird.js"></script>
  <script src="app.js"></script>
  <script>
    // Location-gated buttons handling
    (function() {
      const locationModal = document.getElementById('location-modal');
      const modalGrantBtn = document.getElementById('modal-grant-btn');
      const modalCloseBtn = document.getElementById('modal-close-btn');
      const requiresLocationBtns = document.querySelectorAll('.requires-location');

      function updateButtonStates() {
        const hasLocation = LocationService.hasCached();
        requiresLocationBtns.forEach(btn => {
          if (hasLocation) {
            btn.classList.remove('disabled');
          } else {
            btn.classList.add('disabled');
          }
        });
      }

      // Handle clicks on disabled buttons
      requiresLocationBtns.forEach(btn => {
        btn.addEventListener('click', (e) => {
          if (btn.classList.contains('disabled')) {
            e.preventDefault();
            locationModal.style.display = 'flex';
          }
        });
      });

      // Modal close button
      modalCloseBtn.addEventListener('click', () => {
        locationModal.style.display = 'none';
      });

      // Modal grant button - trigger location request
      modalGrantBtn.addEventListener('click', async () => {
        modalGrantBtn.textContent = 'Getting location...';
        modalGrantBtn.disabled = true;

        try {
          await LocationService.getLocation(true);
          locationModal.style.display = 'none';
          updateButtonStates();
          // Update the location button display
          window.dispatchEvent(new Event('locationUpdated'));
          // Navigate to cache page after getting location
          window.location.href = 'cache';
        } catch (error) {
          alert(error.message);
        } finally {
          modalGrantBtn.textContent = 'Grant Location Access';
          modalGrantBtn.disabled = false;
        }
      });

      // Close modal when clicking outside
      locationModal.addEventListener('click', (e) => {
        if (e.target === locationModal) {
          locationModal.style.display = 'none';
        }
      });

      // Initialize button states
      updateButtonStates();

      // Listen for location updates
      window.addEventListener('locationUpdated', updateButtonStates);
    })();

    // Location status handling
    (function() {
      const locationBtn = document.getElementById('location-btn');
      const locationIcon = document.getElementById('location-icon');
      const locationText = document.getElementById('location-text');

      // Get globe emoji based on continent
      function getGlobeEmoji(countryCode) {
        const continent = BirdDB.getContinent(countryCode);

        if (continent === 'Africa' || continent === 'Europe') {
          return 'ğŸŒ';
        } else if (continent === 'Asia' || continent === 'Oceania') {
          return 'ğŸŒ';
        } else if (continent === 'North America' || continent === 'South America') {
          return 'ğŸŒ';
        } else {
          return 'ğŸŒ';
        }
      }

      // Update location button text and icon
      function updateLocationButton() {
        const cached = LocationService.getCached();

        if (cached) {
          const displayName = LocationService.getRegionDisplayName(cached);
          const globe = getGlobeEmoji(cached.countryCode);
          locationIcon.textContent = globe;
          locationText.textContent = displayName;
          locationBtn.classList.add('location-set');
          locationBtn.classList.remove('location-unset');
        } else {
          locationIcon.textContent = 'ğŸ“';
          locationText.textContent = 'Grant location access';
          locationBtn.classList.add('location-unset');
          locationBtn.classList.remove('location-set');
        }
      }

      // Handle location button click
      locationBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const cached = LocationService.getCached();

        if (cached) {
          // Already have location - go to cache page
          window.location.href = 'cache';
        } else {
          // No location - request GPS immediately
          locationIcon.textContent = 'â³';
          locationText.textContent = 'Getting location...';
          locationBtn.style.pointerEvents = 'none';

          try {
            await LocationService.getLocation(true);
            updateLocationButton();
            // Notify other components that location was updated
            window.dispatchEvent(new Event('locationUpdated'));
            // Navigate to cache page after getting location
            window.location.href = 'cache';
          } catch (error) {
            alert(error.message);
            updateLocationButton();
            locationBtn.style.pointerEvents = 'auto';
          }
        }
      });

      // Initialize on load
      updateLocationButton();

      // Listen for location updates from modal
      window.addEventListener('locationUpdated', updateLocationButton);
    })();

    // Force service worker update
    if ('serviceWorker' in navigator) {
      // Get all registrations and update them
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(registration => {
          console.log('Updating service worker...');
          registration.update();
        });
      });

      // Register service worker with update checking
      navigator.serviceWorker.register('/birdle/sw.js', {
        scope: '/birdle/',
        updateViaCache: 'none'  // Don't cache the service worker file itself
      }).then(registration => {
        console.log('Service worker registered, checking for updates...');
        registration.update();

        // Check for updates every 5 seconds during development
        setInterval(() => {
          registration.update();
        }, 5000);
      });
    }
  </script>
</body>
</html>
