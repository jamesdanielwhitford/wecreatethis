<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#333">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Birdle</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Navbar -->
  <nav class="game-navbar">
    <span style="font-weight: bold; font-size: 18px;">Birdle</span>
    <button id="menu-btn" class="menu-btn">&#8942;</button>
    <div id="menu-dropdown" class="menu-dropdown" style="display:none;">
      <button id="menu-manage-cache">Manage Cache</button>
    </div>
  </nav>

  <p style="margin-top: 20px;">Bird Bingo Adventure</p>

  <div id="location-status">
    <a href="#" id="location-btn" style="color: #c00;">Grant location access</a>
    <div id="cache-status" style="display: none; font-size: 12px; color: #666; margin-top: 4px;"></div>
  </div>

  <!-- Location Access Modal -->
  <div id="location-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3 id="modal-title">Location Access</h3>

      <!-- Main options view -->
      <div id="modal-options" style="display: block;">
        <div class="modal-actions">
          <button id="modal-grant-btn" class="modal-btn seen">Grant Location Access</button>
          <button id="modal-download-btn" class="modal-btn">Download Location for Offline</button>
          <button id="modal-update-btn" class="modal-btn" style="display: none;">Update with Current Location</button>
          <button id="modal-cancel-btn" class="modal-btn cancel">Cancel</button>
        </div>
      </div>

      <!-- Download location view -->
      <div id="modal-download-view" style="display: none;">
        <div class="form-group">
          <label>Country</label>
          <select id="modal-country" class="form-select">
            <option value="">Select Country...</option>
          </select>
        </div>
        <div class="form-group">
          <label>State/Province</label>
          <select id="modal-state" class="form-select" disabled>
            <option value="">Select State/Province...</option>
          </select>
        </div>
        <div id="download-progress" style="display: none; margin-top: 16px;">
          <div style="font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 500;">
            <span id="download-status">Downloading birds for offline access...</span>
          </div>
          <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
          </div>
          <div id="progress-text" style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;"></div>
          <div style="font-size: 12px; color: #999; margin-top: 8px; text-align: center;">
            Please do not navigate away until complete
          </div>
        </div>
        <div class="modal-actions" style="margin-top: 20px;">
          <button id="modal-download-save-btn" class="modal-btn seen" disabled>Download</button>
          <button id="modal-download-cancel-btn" class="modal-btn cancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <div class="button-container">
    <a href="search" class="btn">
      <span class="btn-icon">üîç</span>
      <span class="btn-text">Search</span>
    </a>

    <a href="life" class="btn">
      <span class="btn-icon">üìã</span>
      <span class="btn-text">Life List</span>
    </a>

    <a href="bingo-games" class="btn">
      <span class="btn-icon">üé≤</span>
      <span class="btn-text">Bird Bingo</span>
    </a>
  </div>

  <script src="db.js?v=91"></script>
  <script src="location.js?v=91"></script>
  <script src="ebird.js?v=91"></script>
  <script src="app.js?v=91"></script>
  <script>
    // Menu button handling
    (function() {
      const menuBtn = document.getElementById('menu-btn');
      const menuDropdown = document.getElementById('menu-dropdown');
      const manageCacheBtn = document.getElementById('menu-manage-cache');

      menuBtn.addEventListener('click', () => {
        const isVisible = menuDropdown.style.display === 'block';
        menuDropdown.style.display = isVisible ? 'none' : 'block';
      });

      manageCacheBtn.addEventListener('click', () => {
        window.location.href = 'cache';
      });

      // Close menu when clicking outside
      document.addEventListener('click', (e) => {
        if (!menuBtn.contains(e.target) && !menuDropdown.contains(e.target)) {
          menuDropdown.style.display = 'none';
        }
      });
    })();

    // Location status handling
    (function() {
      const locationBtn = document.getElementById('location-btn');
      const cacheStatus = document.getElementById('cache-status');
      const modal = document.getElementById('location-modal');
      const modalTitle = document.getElementById('modal-title');

      // Modal views
      const modalOptions = document.getElementById('modal-options');
      const modalDownloadView = document.getElementById('modal-download-view');

      // Main option buttons
      const grantBtn = document.getElementById('modal-grant-btn');
      const downloadBtn = document.getElementById('modal-download-btn');
      const updateBtn = document.getElementById('modal-update-btn');
      const cancelBtn = document.getElementById('modal-cancel-btn');

      // Download view elements
      const countrySelect = document.getElementById('modal-country');
      const stateSelect = document.getElementById('modal-state');
      const downloadProgress = document.getElementById('download-progress');
      const progressText = document.getElementById('progress-text');
      const downloadSaveBtn = document.getElementById('modal-download-save-btn');
      const downloadCancelBtn = document.getElementById('modal-download-cancel-btn');

      // Update location button text and color
      function updateLocationButton() {
        const cached = LocationService.getCached();
        if (cached) {
          const displayName = LocationService.getRegionDisplayName(cached);
          locationBtn.textContent = displayName;
          locationBtn.style.color = '#4caf50';

          // Show update button in modal
          updateBtn.style.display = 'block';

          // Check/trigger country cache
          updateCacheStatus(cached.countryCode);
        } else {
          locationBtn.textContent = 'Grant location access';
          locationBtn.style.color = '#c00';
          updateBtn.style.display = 'none';
          cacheStatus.style.display = 'none';
        }
      }

      // Update cache status display
      async function updateCacheStatus(countryCode) {
        if (!countryCode) return;

        try {
          await BirdDB.init();
          const hasCache = await BirdDB.hasCountryCache(countryCode);

          if (hasCache) {
            const meta = await BirdDB.getCountryCacheMeta(countryCode);
            cacheStatus.textContent = `${meta.speciesCodes.length} birds cached`;
            cacheStatus.style.display = 'block';
            cacheStatus.style.color = '#4caf50';
          } else {
            cacheStatus.style.display = 'none';
          }
        } catch (error) {
          console.error('Error checking cache status:', error);
        }
      }

      // Open modal with dynamic options based on current state
      async function openModal() {
        const cached = LocationService.getCached();
        const hasLocation = cached !== null;
        const hasGPS = hasLocation && LocationService.hasValidCoordinates(cached);
        const hasCachedBirds = hasLocation && await BirdDB.hasCountryCache(cached.countryCode);

        // Show/hide buttons based on state
        if (hasGPS) {
          // Has GPS location - hide "Grant" button, show "Update"
          grantBtn.style.display = 'none';
          updateBtn.style.display = 'block';
        } else {
          // No GPS location - show "Grant" button, hide "Update"
          grantBtn.style.display = 'block';
          updateBtn.style.display = 'none';
        }

        // Show/hide download button based on whether birds are cached
        if (hasCachedBirds) {
          // Already cached - change button text to indicate re-download
          downloadBtn.textContent = 'Change or Re-download Location';
        } else {
          downloadBtn.textContent = 'Download Location for Offline';
        }

        modalOptions.style.display = 'block';
        modalDownloadView.style.display = 'none';
        modal.style.display = 'flex';
        modalTitle.textContent = hasLocation ? 'Update Location' : 'Location Access';
      }

      // Close modal
      function closeModal() {
        modal.style.display = 'none';
        modalOptions.style.display = 'block';
        modalDownloadView.style.display = 'none';
      }

      // Grant location access (GPS)
      async function grantLocationAccess() {
        const originalText = grantBtn.textContent;
        grantBtn.textContent = 'Getting location...';
        grantBtn.disabled = true;

        try {
          await LocationService.getLocation(true);
          updateLocationButton();
          closeModal();
        } catch (error) {
          alert(error.message);
          grantBtn.textContent = originalText;
          grantBtn.disabled = false;
        }
      }

      // Update with current location (GPS refresh)
      async function updateCurrentLocation() {
        const originalText = updateBtn.textContent;
        updateBtn.textContent = 'Updating...';
        updateBtn.disabled = true;

        try {
          await LocationService.getLocation(true);
          updateLocationButton();
          closeModal();
        } catch (error) {
          alert(error.message);
          updateBtn.textContent = originalText;
          updateBtn.disabled = false;
        }
      }

      // Show download location view
      async function showDownloadView() {
        modalOptions.style.display = 'none';
        modalDownloadView.style.display = 'block';
        modalTitle.textContent = 'Download Location';

        // Load countries if not already loaded
        if (countrySelect.options.length <= 1) {
          countrySelect.innerHTML = '<option value="">Loading...</option>';
          const countries = await EBird.getCountries();
          countrySelect.innerHTML = '<option value="">Select Country...</option>';
          countries.forEach(c => {
            countrySelect.innerHTML += `<option value="${c.code}">${c.name}</option>`;
          });
        }

        // Pre-select current location if cached
        const cached = LocationService.getCached();
        if (cached && cached.countryCode) {
          countrySelect.value = cached.countryCode;
          await loadStates(cached.countryCode);
          if (cached.stateCode) {
            stateSelect.value = cached.stateCode;
          }
        }

        validateDownloadForm();
      }

      // Load states for selected country
      async function loadStates(countryCode) {
        stateSelect.innerHTML = '<option value="">Loading...</option>';
        stateSelect.disabled = true;

        if (countryCode) {
          const states = await EBird.getStates(countryCode);
          stateSelect.innerHTML = '<option value="">Select State/Province...</option>';
          states.forEach(s => {
            stateSelect.innerHTML += `<option value="${s.code}">${s.name}</option>`;
          });
          stateSelect.disabled = false;
        } else {
          stateSelect.innerHTML = '<option value="">Select State/Province...</option>';
        }
      }

      // Validate download form
      function validateDownloadForm() {
        downloadSaveBtn.disabled = !countrySelect.value;
      }

      // Download and save location with birds
      async function downloadAndSaveLocation() {
        const countryCode = countrySelect.value;
        const countryName = countrySelect.options[countrySelect.selectedIndex].text;
        const stateCode = stateSelect.value || null;
        const stateName = stateCode ? stateSelect.options[stateSelect.selectedIndex].text : null;

        // Save location first
        const location = {
          lat: 0,
          lng: 0,
          countryCode,
          countryName,
          stateCode,
          stateName,
          displayName: stateName ? `${stateName}, ${countryName}` : countryName
        };
        LocationService.saveToCache(location);

        // Get progress elements
        const progressBar = document.getElementById('progress-bar');
        const downloadStatus = document.getElementById('download-status');

        // Show progress
        downloadProgress.style.display = 'block';
        downloadSaveBtn.disabled = true;
        downloadCancelBtn.disabled = true;
        progressBar.style.width = '0%';

        try {
          await BirdDB.init();

          await BirdDB.cacheCountryBirds(countryCode, (progress) => {
            if (progress.phase === 'fetching') {
              downloadStatus.textContent = 'Fetching species list...';
              progressBar.style.width = '10%';
              progressText.textContent = `Found ${progress.total} species`;
            } else if (progress.phase === 'caching') {
              downloadStatus.textContent = 'Downloading birds for offline access...';
              const percent = Math.round((progress.cached / progress.total) * 100);
              progressBar.style.width = `${percent}%`;
              progressText.textContent = `${progress.cached} / ${progress.total} birds cached`;
            } else if (progress.phase === 'done') {
              downloadStatus.textContent = 'Download complete!';
              progressBar.style.width = '100%';
              progressText.textContent = `${progress.cached} birds ready for offline use`;
            }
          });

          updateLocationButton();
          setTimeout(() => {
            closeModal();
            downloadProgress.style.display = 'none';
            downloadSaveBtn.disabled = false;
            downloadCancelBtn.disabled = false;
            progressBar.style.width = '0%';
          }, 1500);
        } catch (error) {
          console.error('Error caching birds:', error);
          alert('Failed to download birds. Please try again.');
          downloadProgress.style.display = 'none';
          downloadSaveBtn.disabled = false;
          downloadCancelBtn.disabled = false;
          progressBar.style.width = '0%';
        }
      }

      // Event listeners
      locationBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        await BirdDB.init(); // Ensure DB is ready
        await openModal();
      });

      grantBtn.addEventListener('click', grantLocationAccess);
      downloadBtn.addEventListener('click', showDownloadView);
      updateBtn.addEventListener('click', updateCurrentLocation);
      cancelBtn.addEventListener('click', closeModal);

      countrySelect.addEventListener('change', async (e) => {
        await loadStates(e.target.value);
        validateDownloadForm();
      });

      stateSelect.addEventListener('change', validateDownloadForm);

      downloadSaveBtn.addEventListener('click', downloadAndSaveLocation);
      downloadCancelBtn.addEventListener('click', () => {
        modalOptions.style.display = 'block';
        modalDownloadView.style.display = 'none';
        modalTitle.textContent = 'Location Access';
        downloadProgress.style.display = 'none';
      });

      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });

      // Initialize on load
      updateLocationButton();
    })();

    // Force service worker update
    if ('serviceWorker' in navigator) {
      // Get all registrations and update them
      navigator.serviceWorker.getRegistrations().then(registrations => {
        registrations.forEach(registration => {
          console.log('Updating service worker...');
          registration.update();
        });
      });

      // Register service worker with update checking
      navigator.serviceWorker.register('/birdle/sw.js', {
        scope: '/birdle/',
        updateViaCache: 'none'  // Don't cache the service worker file itself
      }).then(registration => {
        console.log('Service worker registered, checking for updates...');
        registration.update();

        // Check for updates every 5 seconds during development
        setInterval(() => {
          registration.update();
        }, 5000);
      });
    }
  </script>
</body>
</html>
